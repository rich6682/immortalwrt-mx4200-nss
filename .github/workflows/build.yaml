name: Build ImmortalWRT MX4200v1 (NSS) and Release

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 480
    env:
      TZ: 'Asia/Ho_Chi_Minh'

    steps:
      - name: Checkout repo (this repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential ccache bzip2 gcc g++ make patch git gettext \
            libncurses5-dev zlib1g-dev gawk flex git-core libssl-dev \
            xsltproc unzip python3 python3-pip python3-setuptools file rsync subversion \
            automake autoconf libtool bc

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('**/mx4200v1.config') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Clone ImmortalWRT-IPQ (Gaojianli openwrt-24.10-nss)
        run: |
          git clone --depth 1 -b openwrt-24.10-nss https://github.com/Gaojianli/immortalwrt-ipq.git immortalwrt

      - name: Cache OpenWrt downloads (dl)
        uses: actions/cache@v4
        with:
          path: immortalwrt/dl
          key: ${{ runner.os }}-immortalwrt-dl-${{ hashFiles('mx4200v1.config') }}
          restore-keys: |
            ${{ runner.os }}-immortalwrt-dl-

      - name: Copy MX4200 config into ImmortalWRT tree
        run: |
          cp mx4200v1.config immortalwrt/configs/mx4200v1.config || true
          ls -l immortalwrt/configs | sed -n '1,200p'

      - name: Start OpenWrt/ImmortalWRT build
        run: |
          set -e
          cd immortalwrt

          # update feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # use provided config file as the .config
          cp configs/mx4200v1.config .config

          # populate any new defaults
          make defconfig

          # build (verbose output)
          make -j$(nproc) V=s 2>&1 | tee build.log

      - name: Upload build artifacts to Actions
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-mx4200-artifacts-${{ github.run_number }}
          path: immortalwrt/bin/targets/**

      - name: Upload build log to Actions
        uses: actions/upload-artifact@v4
        with:
          name: build-log-${{ github.run_number }}
          path: immortalwrt/build.log

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: build-${{ github.run_number }}
          name: ImmortalWRT MX4200v1 NSS Build #${{ github.run_number }}
          body: |
            Automated build of ImmortalWRT (NSS enabled) for Linksys MX4200v1.
            Branch: openwrt-24.10-nss
            Config: mx4200v1.config
            Build run: ${{ github.run_number }}
          files: |
            immortalwrt/bin/targets/**/*.bin
            immortalwrt/bin/targets/**/*.manifest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
